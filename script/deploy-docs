#!/bin/bash
set -e

if [ -z "$NOW_TOKEN" ]; then
    echo "NOW_TOKEN is not set; skipping docs deployment"
else
    cp modules/primer/build/build.css docs/static/primer.css
    cd docs
    npm run sync
    now="now --token=$NOW_TOKEN"
    $now | tee now-url.txt
    url=$(cat now-url.txt)
    version=$(jq -r .version ../modules/primer/package.json)
    npx commit-status success docs "deployed primer@$version to $url" "$url"
    if [[ $TRAVIS_EVENT_TYPE = "pull_request" ]]; then
        branch=$TRAVIS_PULL_REQUEST_BRANCH
    else
        branch=$TRAVIS_BRANCH
    fi
    alias="primer-css-${branch//\./-}.now.sh"
    echo "aliasing..."
    $now alias $url $alias
    url="https://$alias"
    npx commit-status success docs "deployed primer@$version to $url" "$url"
fi
